jQuery.extend({openStepByNumber:function(e,t){void 0===t&&(t=!1),$.setUrlParameter("step",e),$(".cart-step-title ").removeClass("active").removeClass("current"),$("#cart-step-"+e+"-title").addClass("current"),$(".cart-step").hide();var a,n=$("#cart-step-"+e);for($(".cart-step.current").removeClass("current"),n.show().addClass("current"),$.scrollToTop($("#cart")),a=1;a<=e;a++)$("#"+n.attr("id")+"-title").addClass("active"),a<e&&$("#cart-step-"+a+"-title").addClass("active");t&&($("#cart-step-"+t+"-title").removeClass("active"),$("#cart-step-"+t+"1-title").removeClass("active")),2==e?$(".cart-products").addClass("hidden"):$(".cart-products").removeClass("hidden"),$(document).find('[data-type="lookup"]:not(.select2-hidden-accessible)').each(function(){$.initializeLookup($(this))})},recalculateTotalPrice:function(){var e=$("#cart form");$.ajax({url:"/cart/recalculate_totals",method:"GET",data:{form:e.serialize()},cache:!1}).done(function(e){0==e.error?$("#cart-step-2 .cart-totals").replaceWith(e.html):$.growl.error({title:e.title?e.title:"",message:e.message?e.message:""}),$.hideAjaxLoader()})},postDeliveryReset:function(){},handleOnPaymentChange:function(e){var t=e.find(":selected").data("description");t||(t=""),e.closest(".form-group").find(".description").html(t),$.recalculateTotalPrice()},postPaymentReset:function(){},handleCartProceed:function(e){$.openStepByNumber(e)},checkQuoteStatus:function(){$.ajax({url:"/api/kekspay_check_transaction",method:"POST",data:{quote_hash:$("[data-keks-hash]").data("keks-hash")},cache:!1}).done(function(e){e.order_created&&($(document).trigger("stop-check-quote-status"),null!=e.quoteSuccessUrl?window.location.href=e.quoteSuccessUrl:window.location.href="/"),$.hideAjaxLoader()})},cartRegister:function(e){var t={};return t.recaptcha_response=e.find('[name="recaptcha_response"]').val(),t.is_legal_entity=e.find('[name="is_private_r1"]').is(":checked")?1:0,t.email=e.find('[name="email"]').val(),t.create_account=e.find('[name="create_account"]').is(":checked")?1:0,t.password=e.find('[name="password"]').val(),t.repeat_password=e.find('[name="repeat_password"]').val(),t.first_name=e.find('[name="first_name"]').val(),t.last_name=e.find('[name="last_name"]').val(),t.country_id=e.find('[name="country_id"]').val(),e.find('[name="city_id"]').length&&(t.city_id=e.find('[name="city_id"]').val()),e.find('[name="city_name"]').length&&(t.city_name=e.find('[name="city_name"]').val()),e.find('[name="postal_code"]').length&&(t.postal_code=e.find('[name="postal_code"]').val()),t.street=e.find('[name="street"]').val(),t.phone=e.find('[name="phone"]').val(),t.birth_day=e.find('[name="birth_day"]').val(),t.birth_month=e.find('[name="birth_month"]').val(),t.birth_year=e.find('[name="birth_year"]').val(),t.name=e.find('[name="company_name"]').val(),t.oib=e.find('[name="oib"]').val(),t.newsletter_signup=$('#cart [name="newsletter_signup"]').is(":checked")?1:0,$.ajax({url:"/cart/update_cart_customer_data",method:"POST",data:t,cache:!1}).done(function(t){0==t.error?($.cartUpdateDeliveryAddress(e),null!=t.open_login_modal&&t.open_login_modal&&$("#login-form-overlay").length&&$("#login-form-overlay").addClass("active")):($.hideAjaxLoader(),$.growl.error({title:t.title?t.title:"",message:t.message?t.message:""}))}),!1},cartUpdateDeliveryAddress:function(e){var t={};return t.recaptcha_response=e.find('[name="recaptcha_response"]').val(),t.shipping_address_same=e.find('[name="shipping_address_same"]').is(":checked")?1:0,e.find('[name="account_shipping_address_id"]').length?t.shipping_address_id=e.find('[name="account_shipping_address_id"]').val():e.find('[name="shipping_country_id"]').length&&(t.shipping_city_id=e.find('[name="shipping_city_id"]').val(),t.shipping_city_name=e.find('[name="shipping_city_name"]').val(),t.shipping_postal_code=e.find('[name="shipping_postal_code"]').val(),t.shipping_street=e.find('[name="shipping_street"]').val(),t.shipping_country_id=e.find('[name="shipping_country_id"]').val(),t.shipping_first_name=e.find('[name="shipping_first_name"]').val(),t.shipping_last_name=e.find('[name="shipping_last_name"]').val(),t.shipping_phone=e.find('[name="shipping_phone"]').val()),$.ajax({url:"/cart/update_cart_delivery_address",method:"POST",data:t,cache:!1}).done(function(t){0==t.error?$.cartUpdatePaymentAndDelivery(e):($.hideAjaxLoader(),$.growl.error({title:t.title?t.title:"",message:t.message?t.message:""}))}),!1},cartUpdatePaymentAndDelivery:function(e){var t={};return t.delivery_type_id=e.find('[name="delivery_type_id"]').val(),t.payment_type_id=e.find('[name="payment_type_id"]').val(),$.ajax({url:"/cart/update_cart_payment_and_delivery",method:"POST",data:t,cache:!1}).done(function(t){0==t.error?$.cartUpdateMessage(e):($.hideAjaxLoader(),$.growl.error({title:t.title?t.title:"",message:t.message?t.message:""}))}),!1},cartUpdateMessage:function(e){var t={};return t.message=e.find('[name="message"]').val(),$.ajax({url:"/cart/update_cart_message",method:"POST",data:t,cache:!1}).done(function(e){0==e.error?$.generateConfirmModal():($.hideAjaxLoader(),$.growl.error({title:e.title?e.title:"",message:e.message?e.message:""}))}),!1},generateConfirmModal:function(){return $.ajax({url:"/cart/generate_confirm_modal",method:"POST",data:{},cache:!1}).done(function(e){if(0==e.error)if($(".overlay").removeClass("active"),e.redirect_url)window.location.href=e.redirect_url;else{var t=$("#cart-confirm");0==t.length&&(t=$("<div class='overlay' id='cart-confirm'></div>"),$("body").append(t)),t.html(e.html),t.addClass("active"),$("body").addClass("disable-scroll"),$("[data-keks-hash]").length&&$(document).trigger("check-quote-status")}else $.growl.error({title:e.title?e.title:"",message:e.message?e.message:""});$.hideAjaxLoader()}),!1},handleSubmitDisable:function(){var e=!0;$('input[type="checkbox"][data-submit-enable="true"]').each(function(){$(this).is(":checked")||(e=!1)}),e?$(".button.toggleable").removeClass("disabled").prop("disabled",!1):$(".button.toggleable").addClass("disabled").prop("disabled",!0)}}),jQuery(document).ready(function(e){e(document).on("click",".checkout-view .expand","change",function(t){t.preventDefault(),t.stopImmediatePropagation(),e(this).parents(".product-display-grid").toggleClass("expanded").next().slideToggle()});var t=function(){var t;!e("#cart").hasClass("marketing-on")&&(t=e("#cart").find('[name="email"]').val(),/^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/.test(t))&&e("#cart").find('[data-id="accept_terms"]').prop("checked")&&(e("#cart").addClass("marketing-on"),e.ajax({url:"/cart/update_cart_customer_marketing_data",method:"POST",data:e("#cart-step-2").find(".basic-information").parents("form").serialize(),cache:!1}).done(function(e){}))};e(document).on("change",'#cart [name="email"]',"change",function(e){e.preventDefault(),e.stopImmediatePropagation(),t()}),e(document).on("change",'#cart [data-id="accept_terms"]',function(e){t()}),e(document).on("click","#cart-confirm a",function(t){0==e(this).closest(".cart-final-buttons").length&&(t.preventDefault(),t.stopImmediatePropagation())});var a=function(t){t.is(":checked")?e(".send-multiple-form-group").slideDown().removeClass("optional"):e(".send-multiple-form-group").slideUp().addClass("optional")};e("#cart input#send_multiple").length&&a("#cart input#send_multiple"),e(document).on("change","#cart input#send_multiple",function(){a(e(this))}),e('input[type="checkbox"][data-submit-enable="true"]').length&&e.handleSubmitDisable(),e(document).on("change",'input[type="checkbox"][data-submit-enable="true"]',function(){var t=e(this).prop("checked"),a=e(this).data("id");e('[data-id="'+a+'"]').each(function(){e(this).prop("checked",t),t?e(this).closest(".custom-checkbox").addClass("checked"):e(this).closest(".custom-checkbox").removeClass("checked")}),e.handleSubmitDisable()});var n=function(t,a){e.emailIsValid(t)?e.ajax({url:"/cart/validate_customer_email",method:"POST",data:{email:t,recaptcha_response:a.parents("form, .form").find('[name="recaptcha_response"]').val()},cache:!1}).done(function(t){0==t.error?a.removeClass("not-valid"):(e.growl.error({title:t.title?t.title:"",message:t.message?t.message:""}),a.addClass("not-valid"))}):(e.growl.error({title:translations.invalid_email,message:""}),a.addClass("not-valid"))};e(document).on("change",'#cart [name="email"]',e.debounce(function(){if(e('#cart [name="create_account"]').length&&e('#cart [name="create_account"]').is(":checked")){var t=e(this).val();n(t,e(this))}},500)),e(document).on("change",'#cart [name="create_account"]',e.debounce(function(){if(e(this).is(":checked")){var t=e(this).parents("form").find('[name="email"]').val();n(t,e(this))}},500));var i=function(t){t.is(":checked")?e(".delivery-address-data").slideUp().addClass("optional"):e(".delivery-address-data").slideDown().removeClass("optional")};e("input#delivery_address").length&&i(e("input#delivery_address")),e(document).on("change","input#delivery_address",function(){i(e(this))});var r=function(t){t.is(":checked")?e(".form-row.passwords").slideDown().removeClass("optional"):e(".form-row.passwords").slideUp().addClass("optional")};if(e("#cart input#create_account").length&&r(e("#cart input#create_account")),e(document).on("change","#cart input#create_account",function(){r(e(this))}),e('[name="delivery_type_id"]').length){var o=function(){e('[name="delivery_type_id"]').hasClass("select2-hidden-accessible")?e('[name="delivery_type_id"]').on("select2:select",function(t){var a=t.params.data;""!=a.is_delivery&&1==a.is_delivery?e(".form-section.delivery-address").removeClass("hidden").removeClass("optional"):e(".form-section.delivery-address").addClass("hidden").addClass("optional")}):1==e('[name="delivery_type_id"] option:selected').data("is_delivery")?e(".form-section.delivery-address").removeClass("hidden").removeClass("optional"):e(".form-section.delivery-address").addClass("hidden").addClass("optional")};o(),e('[name="delivery_type_id"]').on("change",function(){o()})}var s=e.getUrlParam("step");0!==s&&e.openStepByNumber(s),e(document).on("click",".cart-back",function(){var t=e(this).closest(".cart-step"),a=parseInt(t.data("step"))-1;e("#cart-step-"+a).length||a--,e("#cart-step-"+a).length&&e.openStepByNumber(a,a+1),e.scrollToTop(e("#cart"))}),e(document).on("click","#cart-step-1-title",function(t){t.preventDefault(),t.stopImmediatePropagation(),e(".cart-back").trigger("click")}),e(document).on("click",".cart-proceed",function(t){t.preventDefault();var a=e(".cart-step.current");if(d(a)){var n=parseInt(a.data("step"))+1;e("#cart-step-"+n).length||n++,e("#cart-step-"+n).length&&e.handleCartProceed(n)}}),e(document).on("click",".cart-finish",function(t){if(t.preventDefault(),t.stopImmediatePropagation(),d(e(".cart-step.current"))){e.showAjaxLoader();var a=e("#cart").find(".register-section");a.length&&(a.hasClass("send-data")?e.cartRegister(a):function(t){var a={};a.recaptcha_response=t.find('[name="recaptcha_response"]').val(),t.find('[name="company_name"]').length&&(a.is_legal_entity=t.find('[name="is_private_r1"]').is(":checked")?1:0,a.name=t.find('[name="company_name"]').val(),a.oib=t.find('[name="oib"]').val());e.ajax({url:"/cart/update_cart_legal_data",method:"POST",data:a,cache:!1}).done(function(a){0==a.error?e.cartUpdateDeliveryAddress(t):(e.hideAjaxLoader(),e.growl.error({title:a.title?a.title:"",message:a.message?a.message:""}))})}(a))}});var c=function(t){e.showAjaxLoader();var a=t.data("id");e.ajax({url:"/cart/cart_confirm",method:"POST",data:{},cache:!1}).done(function(t){0==t.error?t.redirect_url?window.location.href=t.redirect_url:e("#"+a).length?e("#"+a).submit():alert("MISSING ACTION"):(e.hideAjaxLoader(),e.growl.error({title:t.title?t.title:"",message:t.message?t.message:""}))})};function d(t){var a=!0;return t.find("[required]").each(function(){var t=!0;if(!(e(this).parents(".optional").length>0||e(this).parents(".form-row.hidden").length>0||(e(this).val()||(t=!1),e(this).is(":checkbox")||e(this).is(":radio")?0===e(this).closest(".form-group").length?0===e(this).closest("form").find("input:checked").length&&(t=!1):0===e(this).closest(".form-group").find("input:checked").length&&(t=!1):(e(this).is("select"),e(this).val()||(t=!1)),e(this).attr("pattern")&&(e(this).val().match(new RegExp(e(this).attr("pattern")))||(t=!1)),t))){var n=e(this).parent().find(".label-text").text();e(this).data("label")&&(n=e(this).data("label")),null!=n&&""!=n&&null!=n||(n=e(this).attr("placeholder")),null!=n&&""!=n&&null!=n||(n=e(this).data("placeholder")),n&&e.growl.error({title:translations.form_error_message,message:n.replace("*","")+" "+translations.is_required}),e(this).addClass("invalid"),e(this).closest(".custom-checkbox").addClass("form-error"),e(this).on("keypress keydown keyup change",function(){e(this).removeClass("invalid")}),a=t}}),a}e(document).on("click",".button.cart-confirmation",function(t){t.preventDefault(),t.stopImmediatePropagation(),e.showAjaxLoader(),c(e(this))}),e(document).on("click",".button.card-payment",function(t){t.preventDefault(),t.stopImmediatePropagation(),e.showAjaxLoader(),c(e(this))}),e(document).on("click",".button.kekspay-button",function(){window.location.href=e(this).attr("href")});var l=function(){var t=e('#cart [name="delivery_type_id"]');if(t.length){t.closest(".form-group").find(".description").html("");var a=e("#cart form");e.ajax({url:t.data("search-url"),method:"GET",data:{form:e.getSerializedFormData(a)},cache:!1}).done(function(a){if(t.find('option:not([value=""])').remove(),0==a.error){var n=t.val(),i=!1,r=null;e.each(a.ret,function(a,o){if(t.hasClass("select2-hidden-accessible"))0==a&&(r=o.id),parseInt(n)==parseInt(o.id)&&(i=!0);else{void 0===o.description&&(o.description="");var s=e("<option>").attr("value",o.id).data("description",o.description).data("is_delivery",o.is_delivery).html(o.html);n||1!=o.use_as_default?o.id==parseInt(n)&&(s.attr("selected","selected"),i=!0):(s.attr("selected","selected"),i=!0),t.append(s)}}),i&&t.val(r).trigger("change"),e.postDeliveryReset()}else e.growl.error({title:a.title?a.title:"",message:a.message?a.message:""})})}},p=function(){var t=e('#cart [name="payment_type_id"]');if(t.data("search-url")){t.closest(".form-group").find(".description").html("");var a=e("#cart form");e.ajax({url:t.data("search-url"),method:"GET",data:{form:e.getSerializedFormData(a)},cache:!1}).done(function(a){if(t.find('option:not([value=""])').remove(),0==a.error){if(a.ret){t.find("option:first-child").text(t.data("placeholder"));var n=t.val(),i=!1,r=null;e.each(a.ret,function(a,o){if(t.hasClass("select2-hidden-accessible"))0==a&&(r=o.id),parseInt(n)==parseInt(o.id)&&(i=!0);else{void 0===o.description&&(o.description="");var s=e("<option>").attr("value",o.id).data("description",o.description).html(o.html);n||1!=o.use_as_default?o.id==parseInt(n)&&(s.attr("selected","selected"),i=!0):(s.attr("selected","selected"),i=!0),t.append(s)}}),i&&t.val(r)}else t.find("option:first-child").text(t.data("missing-delivery-placeholder"));e.postPaymentReset()}else e.growl.error({title:a.title?a.title:"",message:a.message?a.message:""})})}};e(document).on("change",'#cart [name="country_id"]',function(t){t.preventDefault(),t.stopImmediatePropagation(),0==e(this).parents(".overlay").length&&l()}),e(document).on("change",'#cart [name="city_name"][data-type="lookup"]',function(t){t.preventDefault(),t.stopImmediatePropagation(),0==e(this).parents(".overlay").length&&l()}),e(document).on("change",'#cart [name="city_id"][data-type="lookup"]',function(t){t.preventDefault(),t.stopImmediatePropagation(),0==e(this).parents(".overlay").length&&(l(),e.recalculateTotalPrice())}),e(document).on("change",'#cart [name="postal_code"]',function(t){t.preventDefault(),t.stopImmediatePropagation(),0==e(this).parents(".overlay").length&&l()}),e(document).on("change",'#cart [name="shipping_address_same"]',function(e){e.preventDefault(),e.stopImmediatePropagation(),p()}),e(document).on("change",'#cart [name="delivery_type_id"]',function(t){t.preventDefault(),t.stopImmediatePropagation(),p();var a=e(this).find(":selected").data("description");a||(a=""),e(this).closest(".form-group").find(".description").html(a),e.recalculateTotalPrice()}),e(document).on("change",'#cart [name="payment_type_id"]',function(t){t.preventDefault(),t.stopImmediatePropagation(),e.handleOnPaymentChange(e(this))}),e(document).on("change",'#cart [name="account_shipping_address_id"]',function(t){t.preventDefault(),t.stopImmediatePropagation(),p(),e.recalculateTotalPrice()}),e(document).on("change",'#cart [name="shipping_country_id"]',function(e){e.preventDefault(),e.stopImmediatePropagation(),p()}),e(document).on("change",'#cart [name="shipping_city_name"][data-type="lookup"]',function(e){e.preventDefault(),e.stopImmediatePropagation(),p()}),e(document).on("change",'#cart [name="shipping_postal_code"]',function(e){e.preventDefault(),e.stopImmediatePropagation(),p()});var m=0;e(document).on("check-quote-status",function(t){0==e("#cart-confirm .kekspay-button").length&&(m=setInterval(e.checkQuoteStatus,1500))}),e(document).on("stop-check-quote-status",function(e){0!==m&&(clearInterval(m),m=0)}),e(document).on("click",".checkout-view .item-bulk-option",function(t){t.preventDefault();var a=e(this).parents(".product-display-grid").find('.item-cart [name="qty"]');a.val(parseFloat(a.val())+parseInt(e(this).data("to-add"))),e(this).parents(".cart-items").find("#update-cart").trigger("click")}),e(document).on("click",".add-new-button-missing-address",function(t){e(".delivery-address .add-new-button").click()})});
